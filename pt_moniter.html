<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Participant Notifications & Timer</title>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #ffffff;
      padding: 20px;
      text-align: center;
    }

    /* Notification Styles */
    #notifications {
      list-style-type: none;
      padding: 0;
      max-height: 500px;
      overflow-y: auto;
      margin-bottom: 30px;
    }

    .notification {
      padding: 10px;
      margin: 5px 0;
      color: #ffffff;
      font-weight: bold;
      border-radius: 5px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      border: 5px solid;
    }

    /* Timer Styles */
    #timerContainer {
      background-color: darkred;
      padding: 20px;
      border-radius: 10px;
      margin-top: 30px;
    }

    button {
      background-color: #808080;
      color: darkred;
      border: none;
      padding: 15px 20px;
      font-size: 18px;
      margin: 10px;
      cursor: pointer;
    }

    #timeDisplay {
      font-size: 60px;
      margin-top: 40px;
    }

    #warning {
      font-size: 100px;
      margin-top: 20px;
      font-weight: bold;
    }

    /* Offset Controls */
    #offsetControls {
      position: fixed;
      bottom: 10px;
      left: 10px;
      right: 10px;
      background: #333;
      padding: 10px;
      border-radius: 5px;
      text-align: left;
    }

    #offsetControls label {
      margin-right: 5px;
    }

    #offsetControls input {
      width: 120px;
      margin-right: 20px;
    }

    #refreshButton {
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!-- Live Participant Notifications -->
  <ul id="notifications"></ul>

  <!-- Timer Interface removed -->

  <!-- Offset Input Controls -->
  <div id="offsetControls">
    <label for="participantOffset">Participant Colour Offset:</label>
    <input type="text" id="participantOffset" value="" placeholder="Offset text" />

    <label for="pageOffset">Page Colour Offset:</label>
    <input type="text" id="pageOffset" value="" placeholder="Offset text" />

    <button id="refreshButton">Refresh Colours</button>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBoKMhXWiu-Ryc2d9_WesXx8SkTL5ee7ag",
      authDomain: "iri-experiment-notifications.firebaseapp.com",
      databaseURL: "https://iri-experiment-notifications-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "iri-experiment-notifications",
      storageBucket: "iri-experiment-notifications.firebasestorage.app",
      messagingSenderId: "380971249257",
      appId: "1:380971249257:web:bbf0250ce9e3a93c1bfcf8",
      measurementId: "G-HMN3BGBMBY"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const notificationsRef = db.ref("notifications");
    const notificationsList = document.getElementById("notifications");

    // Global storage for notification data
    let notificationsData = [];

    // Function to generate a pseudo-random dark colour based on a string
    function getPseudoRandomColor(input, offsetText, isPage = false) {
      const combined = offsetText + input;
      let hash = 0;
      for (let i = 0; i < combined.length; i++) {
        hash = combined.charCodeAt(i) + ((hash << 5) - hash);
      }
      let r = (hash & 0xFF) % 100;
      let g = ((hash >> 8) & 0xFF) % 100;
      let b = ((hash >> 16) & 0xFF) % 100;
      return `rgb(${r + 50}, ${g + 50}, ${b + 50})`;
    }

    // Render notifications
    function renderNotifications() {
      notificationsList.innerHTML = "";
      const participantOffsetText = document.getElementById("participantOffset").value || "";
      const pageOffsetText = document.getElementById("pageOffset").value || "";

      const rendered = notificationsData.slice().reverse().slice(0, 10);
      rendered.forEach(data => {
        // Extract expected params: p (participant code), n (display name), s (session),
        // t (trial order), i (trial index, default "0"), m (mode: 0=experiment,1=dev)
        const participantId = data.p || "UNKNOWN";
        const participantName = data.n || "";
        const sessionCode = data.s || "";
        const trialOrder = data.t || "";
        // ensure i defaults to "0" when missing
        const trialIndex = (data.i === undefined || data.i === null || data.i === "") ? "0" : String(data.i);
        const modeRaw = (data.m === undefined || data.m === null) ? "0" : String(data.m);
        const modeLabel = modeRaw === "1" ? "dev" : "experiment";
        const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : "Unknown Time";
        const bgColor = getPseudoRandomColor(participantId, participantOffsetText);
        const borderColor = getPseudoRandomColor(trialOrder, pageOffsetText, true);
        const notificationText = `${timestamp} - Participant ${participantId} ${participantName} | session ${sessionCode} | order ${trialOrder} | trial ${trialIndex} | mode ${modeLabel}`;
        const li = document.createElement("li");
        li.textContent = notificationText;
        li.classList.add("notification");
        li.style.backgroundColor = bgColor;
        li.style.borderColor = borderColor;
        notificationsList.appendChild(li);
      });
    }

    // Update notifications from Firebase
    function updateNotifications(snapshot) {
      notificationsData = [];
      snapshot.forEach(childSnapshot => {
        const data = childSnapshot.val() || {};
        notificationsData.push(data);
      });
      renderNotifications();
    }

    notificationsRef.once("value", updateNotifications);
    notificationsRef.on("child_added", () => {
      notificationsRef.once("value", updateNotifications);
    });

    document.getElementById("refreshButton").addEventListener("click", renderNotifications);
    console.log("Listening for real-time notifications...");

    // Timer logic removed (UI handled elsewhere or not needed)
  </script>
</body>
</html>

